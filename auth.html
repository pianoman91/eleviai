<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EleviAI — Login</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .box { background:#141823; padding:20px; border-radius:12px; }
    input {
      width:100%; margin:8px 0 12px; padding:10px;
      border-radius:8px; border:1px solid #2a3145;
      background:#0c1020; color:white;
    }
    .muted { opacity:0.85; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .btn.small { padding:10px 14px; font-size:14px; }
    pre { white-space:pre-wrap; margin:0; }
  </style>
</head>
<body>
  <div class="container" style="padding:40px 0;">
    <h1>Accedi o registrati</h1>

    <div class="box" style="margin-top:18px;">
      <p id="status" class="muted">Caricamento...</p>

      <label><strong>Email</strong></label>
      <input id="email" type="email" placeholder="es: nome@mail.com" autocomplete="email" />

      <label><strong>Password</strong></label>
      <input id="password" type="password" placeholder="min 6 caratteri" autocomplete="current-password" />

      <div class="row" style="margin-top:8px;">
        <button class="btn small" id="signup">Registrati</button>
        <button class="btn small" id="login">Accedi</button>
        <button class="btn small" id="logout" style="opacity:.85;">Logout</button>
        <button class="btn small" id="resend" style="opacity:.85;">Reinvia verifica email</button>
      </div>

      <hr style="margin:18px 0; border-color:#2a3145;">

      <h3 style="margin:0 0 10px;">Debug sessione</h3>
      <pre id="debug"></pre>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const statusEl = document.getElementById("status");
    const debugEl = document.getElementById("debug");
    const emailEl = document.getElementById("email");
    const pwEl = document.getElementById("password");

    const btnSignup = document.getElementById("signup");
    const btnLogin = document.getElementById("login");
    const btnLogout = document.getElementById("logout");
    const btnResend = document.getElementById("resend");

    async function loadConfig() {
      const r = await fetch("/api/public-config");
      if (!r.ok) throw new Error("public-config non raggiungibile (HTTP " + r.status + ")");
      const j = await r.json();
      if (!j.SUPABASE_URL || !j.SUPABASE_ANON_KEY) {
        throw new Error("Chiavi Supabase mancanti. Configura env vars e fai redeploy.");
      }
      return j;
    }

    function renderSession(session) {
      debugEl.textContent = JSON.stringify(
        {
          hasSession: !!session,
          user: session?.user ? {
            id: session.user.id,
            email: session.user.email,
            email_confirmed_at: session.user.email_confirmed_at
          } : null
        },
        null,
        2
      );
    }

    let supabase;

    async function refresh() {
      const { data: { session } } = await supabase.auth.getSession();

      if (!session) {
        statusEl.textContent = "Non sei loggato.";
        renderSession(null);
        return;
      }

      const confirmed = !!session.user.email_confirmed_at;

      if (confirmed) {
        statusEl.textContent = "Loggato ✅ Email verificata ✅";
      } else {
        statusEl.textContent = "Loggato ✅ Email NON verificata. Verifica la mail oppure reinvia.";
      }

      renderSession(session);
    }

    try {
      const cfg = await loadConfig();
      supabase = createClient(cfg.SUPABASE_URL, cfg.SUPABASE_ANON_KEY);

      supabase.auth.onAuthStateChange(async () => {
        await refresh();
      });

      await refresh();
      statusEl.textContent = statusEl.textContent || "Pronto.";
    } catch (e) {
      console.error(e);
      statusEl.textContent = "Errore: " + (e?.message || String(e));
      debugEl.textContent = "";
    }

    btnSignup.addEventListener("click", async () => {
      const email = emailEl.value.trim();
      const password = pwEl.value.trim();
      if (!email || !password) { alert("Inserisci email e password"); return; }

      const { error } = await supabase.auth.signUp({
        email,
        password,
        options: { emailRedirectTo: window.location.origin + "/auth.html" }
      });

      if (error) alert(error.message);
      else alert("Registrazione ok. Controlla la mail e verifica l’account.");
      await refresh();
    });

    btnLogin.addEventListener("click", async () => {
      const email = emailEl.value.trim();
      const password = pwEl.value.trim();
      if (!email || !password) { alert("Inserisci email e password"); return; }

      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) alert(error.message);
      await refresh();

      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user?.email_confirmed_at) {
        window.location.href = "prova.html";
      }
    });

    btnLogout.addEventListener("click", async () => {
      await supabase.auth.signOut();
      await refresh();
    });

    btnResend.addEventListener("click", async () => {
      const email = emailEl.value.trim();
      if (!email) { alert("Inserisci la tua email nel campo Email"); return; }

      const { error } = await supabase.auth.resend({
        type: "signup",
        email,
        options: { emailRedirectTo: window.location.origin + "/auth.html" }
      });

      if (error) alert(error.message);
      else alert("Email di verifica reinviata (controlla inbox e spam).");
      await refresh();
    });
  </script>
</body>
</html>
